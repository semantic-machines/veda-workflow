@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix v-wf: <http://semantic-machines.com/veda/veda-workflow/> .
@prefix bpmn: <http://semantic-machines.com/veda/veda-bpmn/> .

@prefix s-wf: <http://semantic-machines.com/veda/simple-workflow/> .
@prefix d: <http://semantic-machines.com/veda/veda-data/> .
@prefix td: <http://semantic-machines.com/veda/test-data/> .

<http://semantic-machines.com/veda/simple-task-process-handlers>
  rdf:type owl:Ontology ;
  rdfs:label "Онтология системы Veda"@ru ;
  rdfs:label "Veda system ontology"@en ;
#  owl:versionInfo "1.3" ;
  v-s:loadPriority 6 ;
.

# ------------------------------------------------------------

bpmn:SetPropertyHandler
  rdf:type bpmn:ExternalTaskHandler ;
  rdfs:label "Обработчик топика 'setProperty'" ;
  bpmn:triggerByTopic "setProperty" ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * task = camunda task JSON
 */

console.log('SET PROPERTY');

const object = task.variables.object.value;
const property = task.variables.property.value;
const value = task.variables.value.value;

console.log(object, property, value);

if (object && property && typeof value !== 'undefined') {
  const individual = new veda.IndividualModel(object);
  individual.reset();
  individual.set(property, value);
  individual.save();
}
  """ ;
.

# ------------------------------------------------------------

bpmn:SetRightsHandler
  rdf:type bpmn:ExternalTaskHandler ;
  rdfs:label "Обработчик топика 'setRights'" ;
  bpmn:triggerByTopic "setRights" ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * task = camunda task JSON
 */

console.log('SET RIGHTS');

const subject = task.variables.subject.value;
const object = task.variables.object.value;
let permission = task.variables.permission.value;

permission = permission.split('').map(char => {
  return char === 'c' ? 'v-s:canCreate' :
         char === 'r' ? 'v-s:canRead' :
         char === 'u' ? 'v-s:canUpdate' :
         char === 'd' ? 'v-s:canDelete' :
         undefined;
}).filter(Boolean);

console.log(subject, object, permission);

if (subject && object && permission.length) {
  veda.Util.addRight(ticket, subject, object, permission);
}
  """ ;
.

# ------------------------------------------------------------

bpmn:AssignmentHandler
  rdf:type bpmn:UserTaskHandler ;
  rdfs:label "Обработчик события 'assignment'" ;
  bpmn:triggerByEvent "create" ;
#  bpmn:triggerByProcessId "SimpleTaskProcess" ;
#  bpmn:triggerByElementType "userTask" ;
#  bpmn:triggerByElementId "userTask_1" ;
  bpmn:fetchEventData true ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * event = task event
 * taskId = task id
 * processInstanceId = process instance id
 * superProcessInstanceId = super process instance id
 * businessKey = process instance business key
 * processDefinitionKey = process definition id
 * elementType = task element type
 * elementId = execution element id
 * task = camunda task object
 * variables = camunda task variables object
 */

console.log('CREATE TASK');

if (!variables) throw Error(`Variables object is undefined for camunda task ${taskId}`);

const from_appointment = new veda.IndividualModel(variables.from.value);
from_appointment.reset();
const from = [from_appointment['v-s:employee'][0], from_appointment['v-s:occupation'][0]];

const to_appointment = new veda.IndividualModel(variables.to.value);
to_appointment.reset();
const to = [to_appointment['v-s:employee'][0], to_appointment['v-s:occupation'][0]];

const userTask = new veda.IndividualModel();
userTask['rdf:type'] = ['v-wf:DecisionForm', 'bpmn:DecisionForm'];
userTask['rdfs:label'] = variables.label.value;
userTask['v-s:description'] = variables.description.value;
userTask['bpmn:taskId'] = task.id;
userTask['bpmn:processInstanceId'] = task.processInstanceId;
userTask['bpmn:businessKey'] = businessKey;
userTask['v-wf:possibleDecisionClass'] = variables.possibleDecisionClass.value.replace(/\\s+/g, '').split(',');
userTask['v-s:creator'] = 'cfg:VedaSystem';
userTask['v-wf:from'] = from;
userTask['v-wf:to'] = to;
userTask['v-wf:isCompleted'] = false ;
userTask['v-wf:onDocument'] = variables.document.value ;
userTask.save();

const process_started_record_id = 'd:' + veda.Util.Sha256.hash('process started' + processInstanceId);
const task_created_record = {
  '@': 'd:' + veda.Util.Sha256.hash('task created' + taskId),
  'rdf:type': veda.Util.newUri('bpmn:TaskCreated'),
  'bpmn:hasDecisionForm': veda.Util.newUri(userTask.id),
};
veda.BPMN.addToJournal(process_started_record_id, task_created_record);
  """ ;
.

bpmn:TaskDeletionHandler
  rdf:type bpmn:UserTaskHandler ;
  rdfs:label "Обработчик события 'delete'" ;
  bpmn:triggerByEvent "delete" ;
#  bpmn:triggerByProcessId "SimpleTaskProcess" ;
#  bpmn:triggerByElementType "userTask";
#  bpmn:triggerByElementId "userTask_1";
  bpmn:fetchEventData false ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * event = task event
 * taskId = task id
 * processInstanceId = process instance id
 * superProcessInstanceId = super process instance id
 * businessKey = process instance business key
 * processDefinitionKey = process definition id
 * elementType = task element type
 * elementId = execution element id
 * task = camunda task object
 * variables = camunda task variables object
 */

console.log('REMOVE TASK');
const queryString = `'rdf:type'==='bpmn:DecisionForm' && 'bpmn:taskId'=='\\\\"${taskId}\\\\"'`;
veda.Backend.query(veda.ticket, queryString).then(queryResult => {
  const tasks = queryResult.result;
  tasks.forEach(task => {
    veda.Backend.remove_individual(veda.ticket, task)
      .then(() => console.log(`Task removed: task = ${task}, process = ${processInstanceId}`))
      .catch(error => console.log(`Error removing task: ${task}, process = ${processInstanceId}`, error.stack));
  });
});

const task_created_record_id = 'd:' + veda.Util.Sha256.hash('task created' + taskId);
const task_deleted_record = {
  '@': 'd:' + veda.Util.Sha256.hash('task deleted' + taskId),
  'rdf:type': veda.Util.newUri('bpmn:TaskDeleted'),
};
veda.BPMN.addToJournal(task_created_record_id, task_deleted_record);
  """ ;
.

# ------------------------------------------------------------

bpmn:ProcessInstanceStartHandler
  rdf:type bpmn:ExecutionHandler ;
  rdfs:label "Обработчик события старта экземпляра процесса" ;
  bpmn:triggerByEvent "end" ;
#  bpmn:triggerByProcessId "SimpleTaskProcess" ;
  bpmn:triggerByElementType "startEvent";
#  bpmn:triggerByElementId "startEvent";
  bpmn:fetchEventData true ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * event = execution event
 * executionId = execution id
 * processInstanceId = process instance id
 * superProcessInstanceId = super process instance id
 * businessKey = process instance business key
 * processDefinitionKey = process definition id
 * elementType = execution element type
 * elementId = execution element id
 * execution = camunda execution object
 * variables = camunda execution variables object
 */

console.log('PROCESS INSTANCE STARTED', processDefinitionKey, processInstanceId, superProcessInstanceId);

if (variables && variables.startForm && superProcessInstanceId === 'null') {
  const startForm = JSON.parse(variables.startForm.value);
  if (veda.Util.hasValue(startForm, 'v-wf:onDocument')) {
    const journal_uri = startForm['v-wf:onDocument'][0].data + 'j';
    const process_started_record_id = 'd:' + veda.Util.Sha256.hash('process started' + processInstanceId);
    const process_started_record = {
      '@': process_started_record_id,
      'rdf:type': veda.Util.newUri('bpmn:ProcessStarted'),
      'bpmn:hasStartForm': veda.Util.newUri(startForm['@']),
      'bpmn:processDefinitionKey': veda.Util.newStr(processDefinitionKey),
      'bpmn:processInstanceId': veda.Util.newStr(processInstanceId),
    };
    veda.BPMN.addToJournal(journal_uri, process_started_record);
  }
} else if (superProcessInstanceId !== 'null') {
  const super_process_started_record_id = 'd:' + veda.Util.Sha256.hash('process started' + superProcessInstanceId);
  const process_started_record_id = 'd:' + veda.Util.Sha256.hash('process started' + processInstanceId);
  const process_started_record = {
    '@': process_started_record_id,
    'rdf:type': veda.Util.newUri('bpmn:ProcessStarted'),
    'bpmn:processDefinitionKey': veda.Util.newStr(processDefinitionKey),
    'bpmn:processInstanceId': veda.Util.newStr(processInstanceId),
  };
  veda.BPMN.addToJournal(super_process_started_record_id, process_started_record);
}
  """ ;
.

bpmn:ProcessInstanceEndHandler
  rdf:type bpmn:ExecutionHandler ;
  rdfs:label "Обработчик события завершения экземпляра процесса" ;
  bpmn:triggerByEvent "end" ;
#  bpmn:triggerByProcessId "SimpleTaskProcess" ;
  bpmn:triggerByElementType "null", "endEvent";
#  bpmn:triggerByElementId "null";
  bpmn:fetchEventData false ;
  bpmn:script """
/* Available variables:
 * ticket = superuser ticket
 * event = execution event
 * executionId = execution id
 * processInstanceId = process instance id
 * superProcessInstanceId = super process instance id
 * businessKey = process instance business key
 * processDefinitionKey = process definition id
 * elementType = execution element type
 * elementId = execution element id
 * execution = camunda execution object
 * variables = camunda execution variables object
 */

console.log('PROCESS INSTANCE ENDED', processDefinitionKey, processInstanceId, superProcessInstanceId);

const process_started_record_id = 'd:' + veda.Util.Sha256.hash('process started' + processInstanceId);
const process_ended_record_id = 'd:' + veda.Util.Sha256.hash('process ended' + processInstanceId);
const process_ended_record = {
  '@': process_ended_record_id,
  'rdf:type': veda.Util.newUri('bpmn:ProcessEnded'),
};
veda.BPMN.addToJournal(process_started_record_id, process_ended_record);
  """ ;
.
